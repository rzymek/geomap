<!doctype html>
<html lang="en">
<head>
    <title>Pobieranie mapy</title>
    <script src="capabilities/topo.js" type="text/javascript"></script>
    <script src="capabilities/orto.js" type="text/javascript"></script>
    <script src="capabilities/vmap.js" type="text/javascript"></script>
    <script src="lib/ozimap.js" type="text/javascript"></script>
    <script src="lib/proj4.js" type="text/javascript"></script>
    <script src="lib/linear.js" type="text/javascript"></script>
    <script type="text/javascript">
        var exports = {};
    </script>
    <script src="lib/mgrs.js" type="text/javascript"></script>

    <meta charset="utf-8">
    <script type="text/javascript">
        proj4.defs("PUWG92", "+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs");
        function toKM(v) {
            return (v / 1000).toFixed(0) * 1000;
        }
        /**
         * @param {number[2]} puwg
         */
        function puwg2ll(puwg) {
            return proj4("PUWG92", "WGS84", puwg);
        }
        function utmZone(latLon) {
            return 1 + Math.floor((latLon[0] + 180) / 6);
        }
        /**
         * @param {number[2]} latLon
         */
        function ll2utm(zone, latLon) {
            return proj4("WGS84", "+proj=utm +zone=" + zone + " +north +ellps=WGS84 +datum=WGS84 +units=m +no_defs", latLon);
        }
        function utm2ll(zone, utm) {
            return proj4("+proj=utm +zone=" + zone + " +north +ellps=WGS84 +datum=WGS84 +units=m +no_defs", "WGS84", utm);
        }
        function utm2puwg(zone, utm) {
            return proj4("+proj=utm +zone=" + zone + " +north +ellps=WGS84 +datum=WGS84 +units=m +no_defs", "PUWG92", utm);
        }
        function puwg2utm(zone, puwg) {
            return proj4("PUWG92", "+proj=utm +zone=" + zone + " +north +ellps=WGS84 +datum=WGS84 +units=m +no_defs", puwg);
        }
        function pairToObj(arr) {
            return {
                x: arr[0],
                y: arr[1]
            }
        }
        function svgText(label, x, y, labelsLayer, labelsBgLayer, rotate) {
            var text = svgNew('text');
            text.textContent = label;
            text.setAttribute('x', x);
            text.setAttribute('y', y);
            text.setAttribute('fill', '#000');
            text.style.textAnchor = 'middle';
            text.style.textAlign = 'center';
            text.style.fontSize = '25px';
            labelsLayer.appendChild(text);
            var bbox = text.getBBox();
            var rect = svgNew('rect');
            rect.setAttribute("x", bbox.x);
            rect.setAttribute("y", bbox.y);
            rect.setAttribute("width", bbox.width);
            rect.setAttribute("height", bbox.height);
            rect.setAttribute("fill", "white");
            labelsBgLayer.appendChild(rect, text);
            if(rotate) {
                text.setAttribute("transform", "rotate("+rotate+" "+(bbox.x+bbox.width/2)+" "+(bbox.y+bbox.height/2)+")");
                rect.setAttribute("transform", "rotate("+rotate+" "+(bbox.x+bbox.width/2)+" "+(bbox.y+bbox.height/2)+")");
            }
            return {text: text, bbox: bbox, rect: rect};
        }
        function drawGrid(svg, box, canvasSize) {
            var zone = utmZone(puwg2ll([box.x1, box.y1]));
            var puwg = [
                [box.x1, box.y1],
                [box.x2, box.y1],
                [box.x2, box.y2],
                [box.x1, box.y2],
            ];
            var utmGrid = puwg.map(puwg2utm.bind(null, zone)).map(function (c) {
                return c.map(toKM);
            }).map(pairToObj);

            function puwgToPx(coord) {
                return {
                    x: (coord.x - box.x1) / (box.x2 - box.x1) * canvasSize.width,
                    y: (coord.y - box.y2) / (box.y1 - box.y2) * canvasSize.height
                }
            }

            function utmToPx(coord) {
                return puwgToPx(utm2puwg(zone, coord));
            }

            var corners = [
                {x: 0, y: 0},
                {x: canvasSize.width, y: 0},
                {x: canvasSize.width, y: canvasSize.height},
                {x: 0, y: canvasSize.height}
            ];
            var gridLayer = svgLayer(svg, 'grid');
            var labelsBgLayer = svgLayer(svg, 'labelsBg');
            var labelsLayer = svgLayer(svg, 'labels');
            for (var x = utmGrid[0].x - 1000; x <= utmGrid[1].x + 1000; x += 1000) {
                var p1 = utmToPx({x: x, y: utmGrid[0].y - 1000});
                var p2 = utmToPx({x: x, y: utmGrid[2].y + 1000});
                gridLayer.appendChild(svgLine(p1, p2));
                var top = linear.getIntersect(corners[0], corners[1], p1, p2);
                var bottom = linear.getIntersect(corners[2], corners[3], p1, p2);
                svgText(x, top.x, 25, labelsLayer, labelsBgLayer);
                svgText(x, bottom.x, bottom.y-8, labelsLayer, labelsBgLayer);
            }
            for (var y = utmGrid[0].y - 1000; y <= utmGrid[2].y + 1000; y += 1000) {
                var p1 = utmToPx({x: utmGrid[0].x - 1000, y: y});
                var p2 = utmToPx({x: utmGrid[2].x + 1000, y: y});
                gridLayer.appendChild(svgLine(p1, p2));
                var left = linear.getIntersect(corners[0], corners[3], p1, p2);
                var right= linear.getIntersect(corners[1], corners[2], p1, p2);
                svgText(y, 16, left.y, labelsLayer, labelsBgLayer, -90);
                svgText(y, canvasSize.width-16, right.y, labelsLayer, labelsBgLayer, -90);
            }
        }

        function svgLine(p1, p2, color, w) {
            var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', p1.x);
            line.setAttribute('y1', p1.y);
            line.setAttribute('x2', p2.x);
            line.setAttribute('y2', p2.y);
            line.style.stroke = 'black';
            line.style.strokeOpacity = 0.8;
            line.style.strokeWidth = '1mm';
            return line;
        }

        function svgNew(tag) {
            return document.createElementNS('http://www.w3.org/2000/svg', tag);
        }

        function svgLayer(svg, name) {
            var layer = svgNew('g');
            layer.setAttribute('inkscape:groupmode', 'layer');
            layer.setAttribute('inkscape:label', name);
            svg.appendChild(layer);
            return layer;
        }

        var drawTileFrame = false;
        function fetch() {
            var query = location.search.substr(1).split('|').map(decodeURIComponent);
            var params = {
                source: query[0],
                z: query[1],
                title: query[2],
                box: {
                    x1: query[3],
                    y1: query[4],
                    x2: query[5],
                    y2: query[6]
                }
            };
            document.getElementById('getSource').value = params.source;
            document.getElementById('getZ').value = params.z;
            window.document.title = params.title;
            var box = params.box;

            var source = window[params.source];

            var url = source.url + '?SERVICE=WMTS&REQUEST=GetTile&'
                    + 'VERSION=1.0.0&'
                    + 'LAYER=' + source.name + '&'
                    + 'STYLE=default&'
                    + 'FORMAT=' + source.format + '&'
                    + 'TILEMATRIXSET=EPSG:2180&'
                    + 'TILEMATRIX=EPSG:2180:{{z}}&'
                    + 'TILEROW={{x}}&'
                    + 'TILECOL={{y}}';

            function floor(x) {
                return Math.floor(x);
            }

            var scaleDenominators = source.tiles.EPSG_2180.map(function (it) {
                return it.scaleDenominator;
            });
            var matrixSizes = source.tiles.EPSG_2180.map(function (it) {
                return it.matrixSize;
            });
            var topLeftCorner = {
                y: 850000.0, //X
                x: 100000.0//Y
            };
            var tileWidth = 512;
            var tileHeight = 512;

            var tileZ = params.z;
            var bBoxMinX = box.x1;
            var bBoxMaxX = box.x2;
            var bBoxMinY = box.y1;
            var bBoxMaxY = box.y2;

            var scaleDenominator = scaleDenominators[tileZ];
            var matrixWidth = matrixSizes[tileZ].width;
            var matrixHeight = matrixSizes[tileZ].height;

            var metersPerUnit = 1;
            var pixelSpan = scaleDenominator * 0.28e-3 / metersPerUnit;

            var tileSpanX = tileWidth * pixelSpan;
            var tileSpanY = tileHeight * pixelSpan;

            var tileMatrixMinX = topLeftCorner.x;
            var tileMatrixMaxY = topLeftCorner.y;
            var tileMatrixMaxX = tileMatrixMinX + tileSpanX * matrixWidth;
            var tileMatrixMinY = tileMatrixMaxY - tileSpanY * matrixHeight;

            var tileMinCol = (bBoxMinX - tileMatrixMinX) / tileSpanX;
            var tileMaxCol = (bBoxMaxX - tileMatrixMinX) / tileSpanX;
            var tileMinRow = (tileMatrixMaxY - bBoxMaxY) / tileSpanY;
            var tileMaxRow = (tileMatrixMaxY - bBoxMinY) / tileSpanY;
            // to avoid requesting out-of-range tiles
            if (tileMinCol < 0)
                tileMinCol = 0;
            if (tileMaxCol >= matrixWidth)
                tileMaxCol = matrixWidth - 1;
            if (tileMinRow < 0)
                tileMinRow = 0;
            if (tileMaxRow >= matrixHeight)
                tileMaxRow = matrixHeight - 1;

            /*
             document.writeln(JSON.stringify([
             tileMinRow, tileMinCol,
             tileMaxRow, tileMaxCol
             ]));
             */
            tileExact = {
                x1: tileMinRow,
                y1: tileMinCol,
                x2: tileMaxRow,
                y2: tileMaxCol
            };
            var epsilon = 1e-6;
            var tileBounds = {
                x1: floor(tileExact.x1 + epsilon),
                y1: floor(tileExact.y1 + epsilon),
                x2: floor(tileExact.x2 - epsilon),
                y2: floor(tileExact.y2 - epsilon)
            };

            function interpolate(tile) {
                return url
                        .replace('{{z}}', Math.floor(tileZ))
                        .replace('{{x}}', Math.floor(tile.x))
                        .replace('{{y}}', Math.floor(tile.y));
            }

            function getWorldFile() {
                return [
                    pixelSpan, // poziomy rozmiar pixela w metrach
                    0, // odchylenie pionowe
                    0, // odchylenie poziome
                    -pixelSpan, // pionowy rozmiar pixela w metrach
                    box.x1, // pozioma współrzędna lewego górnego rogu
                    box.y2      // pionowa współrzędna lewego górnego rogu
                ].join('\n');
            }

            var tiles = [];
            for (var x = tileBounds.x1; x <= tileBounds.x2; x++) {
                for (var y = tileBounds.y1; y <= tileBounds.y2; y++) {
                    tiles.push({x: x, y: y});
                }
            }
            var total = tiles.length;
            var status = document.getElementById('status');
            var canvas = document.getElementById('canvas');
            var canvasSize = {
                height: (tileExact.x2 - tileExact.x1) * tileWidth,
                width: (tileExact.y2 - tileExact.y1) * tileHeight
            };
            canvas.width.baseVal.value = canvasSize.width;
            canvas.height.baseVal.value = canvasSize.height;
//            canvas.viewBox.baseVal.x = -canvasSize.width;
//            canvas.viewBox.baseVal.y = -canvasSize.height;
//            canvas.viewBox.baseVal.width = 3*canvasSize.width;
//            canvas.viewBox.baseVal.height = 3*canvasSize.height;
            canvas.viewBox.baseVal.width = canvasSize.width;
            canvas.viewBox.baseVal.height = canvasSize.height;
            document.getElementById('info').innerHTML = canvasSize.width.toFixed(0) + ' x ' + canvasSize.height.toFixed(0);
            var offset = {
                y: (tileExact.x1 - Math.floor(tileExact.x1)) * tileHeight,
                x: (tileExact.y1 - Math.floor(tileExact.y1)) * tileWidth
            };
            var layer = svgLayer(canvas, 'tiles');
            tiles.forEach(function (tile) {
                var x = tile.y - tileBounds.y1;
                var y = tile.x - tileBounds.x1;
                var image = svgNew('image');
                image.width.baseVal.value = tileWidth;
                image.height.baseVal.value = tileHeight;
                image.x.baseVal.value = -offset.x + x * tileWidth;
                image.y.baseVal.value = -offset.y + y * tileHeight;
                image.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', interpolate(tile));
                layer.appendChild(image);
            });

            drawGrid(canvas, box, canvasSize);

            var links = document.getElementById('links');
            var basename = params.source + params.z + '_' + params.title;

            function mklink(type, data) {
                var link = document.createElement('a');
                link.setAttribute('href', 'data:application/octet-stream;charset=utf-8,' + encodeURIComponent(data));
                link.setAttribute('download', basename + "." + type);
                link.innerHTML = type.toUpperCase();
                links.appendChild(link);
            }

            mklink("svg", canvas.parentElement.innerHTML)
            links.appendChild(document.createTextNode(', '));
            mklink("map", getOziMap(basename, [
                /* 0  1 *
                 * 2  3 */
                proj4("PUWG92", "WGS84", [box.x1, box.y2]),
                proj4("PUWG92", "WGS84", [box.x2, box.y2]),
                proj4("PUWG92", "WGS84", [box.x2, box.y1]),
                proj4("PUWG92", "WGS84", [box.x1, box.y1])
            ].map(function (it) {
                // [lon,lat] -> {lat:,lon:}
                return {
                    lon: it[0],
                    lat: it[1]
                };
            }), canvasSize.width, canvasSize.height));
            links.appendChild(document.createTextNode(', '));
            mklink("tfw", getWorldFile());
        }

        function sourceChange(value) {
            var query = location.search.substr(1).split('|').map(decodeURIComponent);
            query[0] = value;
            location.search = query.join('|');
        }
        function zChange(value) {
            var query = location.search.substr(1).split('|').map(decodeURIComponent);
            query[1] = value;
            location.search = query.join('|');
        }
    </script>
    <style>
        #canvas {
            border: solid 1px black;
            transform-origin: 0 0;
            width: 99%;
            height: auto;
        }

        #status, .links {
            font-size: 50px;
        }

        body {
            overflow-x: hidden;
            margin-left: 0;
            margin-right: 0;
        }

        #info {
            position: absolute;
            right: 5px;
            top: 5px;
        }

        @media print {
            .info {
                display: none;
            }
        }
    </style>
</head>
<body onload="fetch()">
<div class="info">
    <div id="info"></div>
    <span id="status"></span>
    <div class="links">
        Zapisz
        <span id="links"></span> lub <a href="javascript:window.print()">Drukuj</a>
    </div>
    <div>
        <select id="getSource" onchange="sourceChange(this.value)">
            <option value="topo">Mapa topograficzna</option>
            <option value="orto">Ortofotomapa</option>
        </select>
        <select id="getZ" onchange="zChange(this.value)">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 - 1:50 000</option>
            <option value="8">8 - 1:25 000</option>
            <option value="9" selected="">9 - 1:10 000</option>
            <option value="10">10 - 1:10 000</option>
            <option value="11">11 - 1:10 000</option>
            <option value="12">12 - 1:10 000</option>
        </select>
    </div>
    <br>
</div>
<div>
    <svg id="canvas" width="1" height="1"
         xmlns="http://www.w3.org/2000/svg"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
    </svg>
</div>
</body>
</html>
