<!doctype html>
<html lang="en">
    <head>
        <title>Fetch</title>
        <script src="capabilities/topo.js" type="text/javascript"></script>
        <script src="capabilities/orto.js" type="text/javascript"></script>
        <script src="capabilities/vmap.js" type="text/javascript"></script>
        <script src="lib/ozimap.js" type="text/javascript"></script>
        <script src="lib/proj4.js" type="text/javascript"></script>

        <meta charset="utf-8"> 
        <script type="text/javascript">
            var drawTileFrame = false;
            function fetch() {
                var params = JSON.parse(window.name);
                var box = params.box;

                var source = window[params.source];

                var url = source.url + '?SERVICE=WMTS&REQUEST=GetTile&'
                        + 'VERSION=1.0.0&'
                        + 'LAYER=' + source.name + '&'
                        + 'STYLE=default&'
                        + 'FORMAT=' + source.format + '&'
                        + 'TILEMATRIXSET=EPSG:2180&'
                        + 'TILEMATRIX=EPSG:2180:{{z}}&'
                        + 'TILEROW={{x}}&'
                        + 'TILECOL={{y}}';
                function floor(x) {
                    return Math.floor(x);
                }

                var scaleDenominators = source.tiles.EPSG_2180.map(function (it) {
                    return it.scaleDenominator;
                });
                var matrixSizes = source.tiles.EPSG_2180.map(function (it) {
                    return it.matrixSize;
                });
                var topLeftCorner = {
                    y: 850000.0, //X
                    x: 100000.0//Y
                };
                var tileWidth = 512;
                var tileHeight = 512;

                var tileZ = params.z;
                var bBoxMinX = box.x1;
                var bBoxMaxX = box.x2;
                var bBoxMinY = box.y1;
                var bBoxMaxY = box.y2;

                var scaleDenominator = scaleDenominators[tileZ];
                var matrixWidth = matrixSizes[tileZ].width;
                var matrixHeight = matrixSizes[tileZ].height;

                var metersPerUnit = 1;
                var pixelSpan = scaleDenominator * 0.28e-3 / metersPerUnit;

                var tileSpanX = tileWidth * pixelSpan;
                var tileSpanY = tileHeight * pixelSpan;

                var tileMatrixMinX = topLeftCorner.x;
                var tileMatrixMaxY = topLeftCorner.y;
                var tileMatrixMaxX = tileMatrixMinX + tileSpanX * matrixWidth;
                var tileMatrixMinY = tileMatrixMaxY - tileSpanY * matrixHeight;

                var tileMinCol = (bBoxMinX - tileMatrixMinX) / tileSpanX;
                var tileMaxCol = (bBoxMaxX - tileMatrixMinX) / tileSpanX;
                var tileMinRow = (tileMatrixMaxY - bBoxMaxY) / tileSpanY;
                var tileMaxRow = (tileMatrixMaxY - bBoxMinY) / tileSpanY;
                // to avoid requesting out-of-range tiles
                if (tileMinCol < 0)
                    tileMinCol = 0;
                if (tileMaxCol >= matrixWidth)
                    tileMaxCol = matrixWidth - 1;
                if (tileMinRow < 0)
                    tileMinRow = 0;
                if (tileMaxRow >= matrixHeight)
                    tileMaxRow = matrixHeight - 1;

                /*
                 document.writeln(JSON.stringify([
                 tileMinRow, tileMinCol,
                 tileMaxRow, tileMaxCol
                 ]));
                 */
                tileExact = {
                    x1: tileMinRow,
                    y1: tileMinCol,
                    x2: tileMaxRow,
                    y2: tileMaxCol
                };
                var epsilon = 1e-6;
                var tileBounds = {
                    x1: floor(tileExact.x1 + epsilon),
                    y1: floor(tileExact.y1 + epsilon),
                    x2: floor(tileExact.x2 - epsilon),
                    y2: floor(tileExact.y2 - epsilon)
                };

                function interpolate(tile) {
                    return url
                            .replace('{{z}}', Math.floor(tileZ))
                            .replace('{{x}}', Math.floor(tile.x))
                            .replace('{{y}}', Math.floor(tile.y));
                }

                function getWorldFile() {
                    return [
                        pixelSpan, // poziomy rozmiar pixela w metrach
                        0, // odchylenie pionowe
                        0, // odchylenie poziome
                        -pixelSpan, // pionowy rozmiar pixela w metrach
                        box.x1, // pozioma współrzędna lewego górnego rogu
                        box.y2      // pionowa współrzędna lewego górnego rogu 
                    ].join('\n');
                }

                var tiles = [];
                for (var x = tileBounds.x1; x <= tileBounds.x2; x++) {
                    for (var y = tileBounds.y1; y <= tileBounds.y2; y++) {
                        tiles.push({x: x, y: y});
                    }
                }
                var total = tiles.length;
                var status = document.getElementById('status');
                var canvas = document.getElementById('canvas');
                status.innerHTML = (total - tiles.length) + '/' + total;
                canvas.height = (tileExact.x2 - tileExact.x1) * tileWidth;
                canvas.width = (tileExact.y2 - tileExact.y1) * tileHeight;
                document.getElementById('info').innerHTML = canvas.width + ' x ' + canvas.height;
                offset = {
                    y: (tileExact.x1 - Math.floor(tileExact.x1)) * tileHeight,
                    x: (tileExact.y1 - Math.floor(tileExact.y1)) * tileWidth
                };
                var ctx = canvas.getContext('2d');
                var img = document.getElementById('fetcher'); //document.createElement('img');
                img.onload = function () {
                    var tile = tiles.shift();
                    var x = tile.y - tileBounds.y1;
                    var y = tile.x - tileBounds.x1;
                    ctx.drawImage(img,
                            -offset.x + x * tileWidth,
                            -offset.y + y * tileHeight);
                    if (drawTileFrame) {
                        ctx.rect(
                                -offset.x + x * tileWidth,
                                -offset.y + y * tileHeight, tileWidth, tileHeight);
                        ctx.stroke();
                    }

                    if (tiles.length > 0) {
                        img.src = interpolate(tiles[0]);
                        status.innerHTML = (total - tiles.length) + '/' + total;
                    } else {
                        status.innerHTML = 'Zapisz poniższy obraz oraz  <a href=""></a>';
                        var links = document.getElementById('links');
                        var basename = params.source + params.z + '_' + params.title;

                        function mklink(type, data) {
                            var link = document.createElement('a');
                            link.setAttribute('href', 'data:application/octet-stream;charset=utf-8,' + encodeURIComponent(data));
                            link.setAttribute('download', basename + "." + type);
                            link.innerHTML = type.toUpperCase();
                            links.appendChild(link);
                        }

                        proj4.defs("EPSG:2180", "+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs");

                        mklink("tfw", getWorldFile());
                        links.appendChild(document.createTextNode(' lub '));
                        mklink("map", getOziMap(basename, [
                            /* 0  1 *
                             * 2  3 */
                            proj4("EPSG:2180", "WGS84", [box.x1, box.y2]),
                            proj4("EPSG:2180", "WGS84", [box.x2, box.y2]),
                            proj4("EPSG:2180", "WGS84", [box.x2, box.y1]),
                            proj4("EPSG:2180", "WGS84", [box.x1, box.y1])
                        ].map(function (it) {
                            // [lon,lat] -> {lat:,lon:}
                            return {
                                lon: it[0],
                                lat: it[1]
                            };
                        }), canvas.width, canvas.height));

                        img.remove();
                    }
                };
                img.src = interpolate(tiles[0]);
            }
        </script>
        <style>
            canvas{
                border:solid 1px black;
                transform-origin: 0 0;
                width: 99%;
            }
            #status,#links {
                font-size: 50px;
            }
            body {
                overflow-x: hidden;
                margin-left: 0;
                margin-right: 0;
            }
            #info {
                position: absolute;
                right:5px;
                top: 5px;
            }
        </style>
    </head>
    <body onload="fetch()">        
        <img id="fetcher" width="64" height="64" alt="..." src="img/ajax-loader.gif">
        <div id="info"></div> 
        <span id="status"></span>
        <span id="links">
        </span>
        <br>
        <canvas id="canvas" width="1" height="1"></canvas>
    </body>
</html>
