<!doctype html>
<html lang="en">
    <head>
        <title>Fetch</title>
    </head>
    <body>
        <script type="text/javascript">
            var extent = JSON.parse(window.name);
            var box = {
                x1: extent[0],
                y1: extent[1],
                x2: extent[2],
                y2: extent[3]
            };
            var url = 'http://mapy.geoportal.gov.pl/wss/service/WMTS/guest/wmts/TOPO?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=MAPA%20TOPOGRAFICZNA&STYLE=default&FORMAT=image/jpeg&TILEMATRIXSET=EPSG:2180&'
                    + 'TILEMATRIX=EPSG:2180:{{z}}&'
                    + 'TILEROW={{x}}&'
                    + 'TILECOL={{y}}';
            function floor(x) {
                return Math.floor(x);
            }

            var tileZ = 9;
            var bBoxMinX = box.x1;
            var bBoxMaxX = box.x2;
            var bBoxMinY = box.y1;
            var bBoxMaxY = box.y2;

            var scaleDenominator = 9449.404761904761;
            var topLeftCorner = {
                y: 850000.0, //X
                x: 100000.0//Y
            };
            var tileWidth = 512;
            var matrixWidth = 598;
            var tileHeight = 512;
            var matrixHeight = 562;

            var metersPerUnit = 1;
            var pixelSpan = scaleDenominator * 0.28e-3 / metersPerUnit;

            var tileSpanX = tileWidth * pixelSpan;
            var tileSpanY = tileHeight * pixelSpan;

            var tileMatrixMinX = 100000;
            var tileMatrixMaxY = 850000;
            var tileMatrixMaxX = tileMatrixMinX + tileSpanX * matrixWidth;
            var tileMatrixMinY = tileMatrixMaxY - tileSpanY * matrixHeight;

            var epsilon = 1e-6;
            var tileMinCol = floor((bBoxMinX - tileMatrixMinX) / tileSpanX + epsilon);
            var tileMaxCol = floor((bBoxMaxX - tileMatrixMinX) / tileSpanX - epsilon);
            var tileMinRow = floor((tileMatrixMaxY - bBoxMaxY) / tileSpanY + epsilon);
            var tileMaxRow = floor((tileMatrixMaxY - bBoxMinY) / tileSpanY - epsilon);
            // to avoid requesting out-of-range tiles
            if (tileMinCol < 0)
                tileMinCol = 0;
            if (tileMaxCol >= matrixWidth)
                tileMaxCol = matrixWidth - 1;
            if (tileMinRow < 0)
                tileMinRow = 0;
            if (tileMaxRow >= matrixHeight)
                tileMaxRow = matrixHeight - 1;

            document.writeln(JSON.stringify([
                tileMinRow, tileMinCol,
                tileMaxRow, tileMaxCol
            ]));
            var url1 = url
                    .replace('{{z}}', Math.floor(tileZ))
                    .replace('{{x}}', Math.floor(tileMinRow))
                    .replace('{{y}}', Math.floor(tileMinCol));
            document.writeln(url1);
        </script>
    </body>
</html>