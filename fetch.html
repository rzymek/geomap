<!doctype html>
<html lang="en">
    <head>
        <title>Fetch</title>
        <script src="FileSaver.min.js" type="text/javascript"></script>

        <script type="text/javascript">
            function fetch() {
                var box = JSON.parse(window.name);
                var url = 'http://mapy.geoportal.gov.pl/wss/service/WMTS/guest/wmts/TOPO?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=MAPA%20TOPOGRAFICZNA&STYLE=default&FORMAT=image/jpeg&TILEMATRIXSET=EPSG:2180&'
                        + 'TILEMATRIX=EPSG:2180:{{z}}&'
                        + 'TILEROW={{x}}&'
                        + 'TILECOL={{y}}';
                function floor(x) {
                    return Math.floor(x);
                }

                var tileZ = 9;
                var bBoxMinX = box.x1;
                var bBoxMaxX = box.x2;
                var bBoxMinY = box.y1;
                var bBoxMaxY = box.y2;

                var scaleDenominator = 9449.404761904761;
                var topLeftCorner = {
                    y: 850000.0, //X
                    x: 100000.0//Y
                };
                var tileWidth = 512;
                var matrixWidth = 598;
                var tileHeight = 512;
                var matrixHeight = 562;

                var metersPerUnit = 1;
                var pixelSpan = scaleDenominator * 0.28e-3 / metersPerUnit;

                var tileSpanX = tileWidth * pixelSpan;
                var tileSpanY = tileHeight * pixelSpan;

                var tileMatrixMinX = 100000;
                var tileMatrixMaxY = 850000;
                var tileMatrixMaxX = tileMatrixMinX + tileSpanX * matrixWidth;
                var tileMatrixMinY = tileMatrixMaxY - tileSpanY * matrixHeight;

                var epsilon = 1e-6;
                var tileMinCol = floor((bBoxMinX - tileMatrixMinX) / tileSpanX + epsilon);
                var tileMaxCol = floor((bBoxMaxX - tileMatrixMinX) / tileSpanX - epsilon);
                var tileMinRow = floor((tileMatrixMaxY - bBoxMaxY) / tileSpanY + epsilon);
                var tileMaxRow = floor((tileMatrixMaxY - bBoxMinY) / tileSpanY - epsilon);
                // to avoid requesting out-of-range tiles
                if (tileMinCol < 0)
                    tileMinCol = 0;
                if (tileMaxCol >= matrixWidth)
                    tileMaxCol = matrixWidth - 1;
                if (tileMinRow < 0)
                    tileMinRow = 0;
                if (tileMaxRow >= matrixHeight)
                    tileMaxRow = matrixHeight - 1;

                /*
                 document.writeln(JSON.stringify([
                 tileMinRow, tileMinCol,
                 tileMaxRow, tileMaxCol
                 ]));
                 */
                var tileBounds = {
                    x1: tileMinRow,
                    y1: tileMinCol,
                    x2: tileMaxRow,
                    y2: tileMaxCol
                };

                function interpolate(tile) {
                    return url
                            .replace('{{z}}', Math.floor(tileZ))
                            .replace('{{x}}', Math.floor(tile.x))
                            .replace('{{y}}', Math.floor(tile.y));
                }
                
                function finished() {
                    var tfw = [
                        pixelSpan,  // poziomy rozmiar pixela w metrach
                        0,          // odchylenie pionowe
                        0,          // odchylenie poziome
                        -pixelSpan, // pionowy rozmiar pixela w metrach
                        box.x1,     // pozioma współrzędna lewego górnego rogu
                        box.y1      // pionowa współrzędna lewego górnego rogu 
                    ].join('\n');
                    var blob = new Blob([tfw], {type: "application/octet-stream"});
                    saveAs(blob, "map.tfw");
                }

                var tiles = [];
                for (var x = tileBounds.x1; x <= tileBounds.x2; x++) {
                    for (var y = tileBounds.y1; y <= tileBounds.y2; y++) {
                        tiles.push({x: x, y: y});
                    }
                }
                var total = tiles.length;
                var status = document.getElementById('status');
                var canvas = document.getElementById('canvas');
                status.innerHTML = (total - tiles.length) + '/' + total;
                canvas.height = (tileBounds.x2 - tileBounds.x1 + 1) * tileWidth;
                canvas.width = (tileBounds.y2 - tileBounds.y1 + 1) * tileHeight;
                var ctx = canvas.getContext('2d');
                var img = document.getElementById('fetcher'); //document.createElement('img');
                img.onload = function () {
                    var tile = tiles.shift();
                    var y = tile.x - tileBounds.x1;
                    var x = tile.y - tileBounds.y1;
                    ctx.drawImage(img, x * tileWidth, y * tileHeight);
                    if (tiles.length > 0) {
                        img.src = interpolate(tiles[0]);
                        status.innerHTML = (total - tiles.length) + '/' + total;
                    } else {
                        status.innerHTML = 'Zapisz lub skopiuj poniższy obraz';
                        finished();
                        img.remove();
                    }
                };
                img.src = interpolate(tiles[0]);
            }
        </script>
        <style>
            #fetcher {
                border:solid 1px blue;
            }
            canvas{
                border:solid 1px red;
                transform: scale(0.5);
                transform-origin: 0 0;
            }
            #status {
                font-size: 64px;
            }
        </style>
    </head>
    <body onload="fetch()">        
        <img id="fetcher" width="64" height="64" alt="..." src="">
        <span id="status"></span>
        <br>
        <canvas id="canvas" width="1000" height="1000"></canvas>
    </body>
</html>
