<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"> 
        <link rel="stylesheet" href="lib/ol.css" type="text/css">
        <style>
            .map {
                position:absolute;
                top:0;
                left:0;
                right:0;
                bottom:0;
                z-index: 0;
            }
            #layerSelection {
                position: absolute;
                top:5px;
                right: 8px;
                max-height: 25px;
            }
            .coords {
                padding: 3px;
                position: absolute;
                top:30px;
                right: 8px;
                z-index: 1;
                background-color: white;
                white-space: nowrap;
            }
            .coords * {
                white-space: nowrap;
            }
        </style>
        <script src="lib/ol.js" type="text/javascript"></script>
        <script src="lib/proj4.js" type="text/javascript"></script>
        <script type="text/javascript">
            var exports = {};
        </script>
        <script src="lib/mgrs.js" type="text/javascript"></script>
        <title>geomap</title>
    </head>
    <body>
        <div id="map" class="map"></div>       
        <select id="layerSelection" onchange="selectLayer(this)"></select>
        <table class="coords">
            <tr>
                <td>MGRS:</td><td id="mgrs"></td>
            </tr>
            <tr>
                <td>LatLon:</td><td id="latlon"></td>
            </tr>
            <tr>
                <td>Mercator:</td><td id="mercator"></td>
            </tr>
            <tr>
                <td>PUWG:</td><td id="puwg"></td>
            </tr>
        </table>
        <script type="text/javascript">
            var puwg92 = "EPSG:2180";
            proj4.defs(puwg92, "+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs");

            var selection = new ol.source.Vector();
            var sources = {
                'OpenStreetMap': new ol.source.OSM(),
            };
            [
                'Road',
                'Aerial',
                'AerialWithLabels'
            ].forEach(function(style){
                sources['Bing: '+style] = new ol.source.BingMaps({
                    key: 'Apszeg5_v01g6cZjl_9VTYEcC_qchUYPEfVR64qdbgV5aRKfbYTbMeitv3bLEPkq',
                    imagerySet: style
                });
            });

            var layers = [];
            Object.keys(sources).forEach(function (name) {
                layers.push(new ol.layer.Tile({
                    visible: false,
                    preload: Infinity,
                    source: sources[name]
                }));
            });
            layers.push(new ol.layer.Vector({
                source: selection,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 0, 0, 0.2)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 2
                    })
                })
            }));
            var map = new ol.Map({
                target: 'map',
                controls: ol.control.defaults().extend(
                        [
                            new ol.control.MousePosition({
                                coordinateFormat: function (coordinate) {
                                    return exports.forward(coordinate, 5)
                                            .replace(/([0-9]*)([A-Z]*)([0-9]{5})([0-9]{5})/, "$1 $2 $3 $4");
                                },
                                className: '',
                                projection: 'EPSG:4326',
                                target: document.getElementById('mgrs')
                            }),
                            new ol.control.MousePosition({
                                coordinateFormat: function (coordinate) {
                                    return ol.coordinate.toStringXY(coordinate, 4);
                                },
                                className: '',
                                projection: 'EPSG:4326',
                                target: document.getElementById('latlon')
                            }),
                            new ol.control.MousePosition({
                                coordinateFormat: function (coordinate) {
                                    return ol.coordinate.toStringXY(coordinate, 0); // 0 decimal places
                                },
                                className: '',
                                projection: puwg92,
                                target: document.getElementById('puwg')
                            }),
                            new ol.control.MousePosition({
                                coordinateFormat: function (coordinate) {
                                    return ol.coordinate.toStringXY(coordinate, 0);
                                },
                                className: '',
                                target: document.getElementById('mercator')
                            }),
                            new ol.control.ScaleLine(),
                            new ol.control.ZoomSlider()
                        ]),
                layers: layers,
                view: new ol.View({
                    center: ol.proj.transform([21.03, 52.22], 'EPSG:4326', 'EPSG:3857'),
                    zoom: 10
                })
            });

            var dragBox = new ol.interaction.DragBox({
                condition: ol.events.condition.shiftKeyOnly,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: [0, 0, 255, 1]
                    })
                })
            });
            map.addInteraction(dragBox);
            dragBox.on('boxend', function (e) {
                var extent = dragBox.getGeometry().getExtent();
                var x1 = extent[0];
                var y1 = extent[1];
                var x2 = extent[2];
                var y2 = extent[3];
                selection.clear();
                var box = new ol.Feature(new ol.geom.Polygon([
                    [
                        [x1, y1],
                        [x1, y2],
                        [x2, y2],
                        [x2, y1]
                    ]
                ]));
                selection.addFeature(box);
            });
            map.on('click', function (evt) {
                var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
                    return feature;
                });
                if (!feature) {
                    return;
                }
                var bbox = feature.getGeometry().getExtent();
                var puwg = ol.proj.transform(bbox, 'EPSG:3857', 'EPSG:2180');
                var box = {
                    x1: puwg[0],
                    y1: puwg[1],
                    x2: puwg[2],
                    y2: puwg[3]
                };
                window.open('fetch.html', JSON.stringify(box));
            });

            var layerSelection = document.getElementById('layerSelection');
            Object.keys(sources).forEach(function (name) {
                var option = document.createElement('option');
                option.text = name;
                layerSelection.add(option);
            });
            function selectLayer(combo) {
                var idx = combo.selectedIndex;
                var selectableSources = Object.keys(sources).length;
                for (var i = 0; i < selectableSources; i++) {
                    layers[i].setVisible(i === idx);
                }
            }
            selectLayer({selectedIndex: 0});
        </script>
    </body>
</html>