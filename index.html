<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"> 
        <link rel="stylesheet" href="lib/ol.css" type="text/css">
        <style>
            .map {
                position:absolute;
                top:0;
                left:0;
                right:0;
                bottom:0;
                z-index: 0;
            }
            .rightControls {
                position: absolute;
                top:5px;
                right: 8px;
                z-index: 1;
                width:250px;
                text-align: right;
            }
            .rightControls * {
                text-align: left;
            }
            .coords {
                width: 100%;
            }
            .panel{
                margin-top: 3px;
                padding: 3px;
                background-color: white;
                opacity: 0.7;
            }
            #fetcher{
                display: none; //initally
            }
            .help{
                position: absolute;
                top:5px;
                left: 50px;
                background-color: white;
                opacity: 0.9;
                padding: 5px;
                border:solid 1px black;
                width: 300px;
                z-index: 100;
            }
            .close{
                float:right;
                margin: 5px;
            }
        </style>
        <script src="lib/ol.js" type="text/javascript"></script>
        <script src="lib/proj4.js" type="text/javascript"></script>
        <script type="text/javascript">
            var exports = {};
        </script>
        <script src="lib/mgrs.js" type="text/javascript"></script>
        <title>geomap</title>
    </head>
    <body>
        <div class="help">
            <button class="close" onclick="this.parentElement.remove()">X</button>
            <b>Geoportal skany map TOPO</b><br><br>

            Razem z mapą otrzymasz plik <a href="https://en.wikipedia.org/wiki/World_file">World File</a> (map.tfw)
            w układzie współrzędnych
            <a href="https://pl.wikipedia.org/wiki/Uk%C5%82ad_wsp%C3%B3%C5%82rz%C4%99dnych_1992">PUWG-92</a>
            opisujący pozycję mapy. Samą grafikę mapy musisz zapisać klikając na nim prawym klawiszem i wybierając 'Zapisz jako' lub 'Kopiuj obraz'.
            <p>
                Ostatnio geoportal ma chwilowe problemy z serwowaniem map. W razie problemów odśwież stronę pobierania mapy.
            </p>
            Wspierane przeglądarki:
            <a href="https://www.mozilla.org/firefox/">Firefox</a> i
            <a href="http://www.google.com/chrome/">Chrome</a>
        </div>
        <div id="map" class="map"></div>
        <div class="rightControls">
            <select id="layerSelection" onchange="selectLayer(this)"></select>
            <table class="coords panel">
                <tr>
                    <td>MGRS:</td><td id="mgrs"></td>
                </tr>
                <tr>
                    <td>LatLon:</td><td id="latlon"></td>
                </tr>
                <tr>
                    <td>Mercator:</td><td id="mercator"></td>
                </tr>
                <tr>
                    <td>PUWG:</td><td id="puwg"></td>
                </tr>
            </table>
            <div class="panel">
                <div id="selectionInfo"><b>Shift+lewy klawisz myszy</b> zaznacza obszar do pobrania.</div>
                <div id="fetcher">
                    Warstwa:
                    <select id="getSource">
                        <option value="topo">Mapa topograficzna</option>
                        <option value="orto">Ortofotomapa</option>
                    </select>
                    <select id="getZ">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7 - 1:50 000</option>
                        <option value="8">8 - 1:25 000</option>
                        <option value="9" selected="">9 - 1:10 000</option>
                        <option value="10">10 - 1:10 000</option>
                        <option value="11">11 - 1:10 000</option>
                        <option value="12">12 - 1:10 000</option>
                    </select>
                    <button onclick="fetch()">Pobierz</button>
                </div>
            </div>
        </div>
        <script type="text/javascript">

            function getBoundsAndMaxResForWMTS() {

                var scaleDenominator = 9449.404761904761;
                var topLeftCorner = {
                    y: 850000.0, //X
                    x: 100000.0//Y
                };
                var tileWidth = 512;
                var matrixWidth = 598;
                var tileHeight = 512;
                var matrixHeight = 562;

                var standardizedRenderingPixelSize = 0.00028;

                var widthPixel = tileWidth * matrixWidth;
                var heightPixel = tileHeight * matrixHeight;

                var right = (scaleDenominator * widthPixel * standardizedRenderingPixelSize) + topLeftCorner.x;
                var bottom = topLeftCorner.y - (scaleDenominator * heightPixel * standardizedRenderingPixelSize);

                var bounds = [topLeftCorner.x, bottom, right, topLeftCorner.y];
                var maxResolutionW = Math.round((right - topLeftCorner.x) / widthPixel);
                var maxResolutionH = Math.round((topLeftCorner.y - bottom) / heightPixel);

                if (maxResolutionW !== maxResolutionH) {
                    throw new Error('Could not calculate ');
                }

                return {
                    bounds: bounds,
                    maxResolution: maxResolutionW
                };
            }
            var puwg92 = "EPSG:2180";
            proj4.defs(puwg92, "+proj=tmerc +lat_0=0 +lon_0=19 +k=0.9993 +x_0=500000 +y_0=-5300000 +ellps=GRS80 +units=m +no_defs");

            var selectionLayer = new ol.source.Vector();
            var sources = {
                'OpenStreetMap': new ol.source.OSM(),
                'OpenCycleMap': new ol.source.XYZ({
                    url: 'http://tile.opencyclemap.org/cycle/{z}/{x}/{y}.png'
                }),
                'UMP': new ol.source.XYZ({
                    url: 'http://tiles.ump.waw.pl/ump_tiles/{z}/{x}/{y}.png'
                })
            };
            [
                'Road',
                'Aerial',
                'AerialWithLabels'
            ].forEach(function (style) {
                sources['Bing: ' + style] = new ol.source.BingMaps({
                    key: 'Apszeg5_v01g6cZjl_9VTYEcC_qchUYPEfVR64qdbgV5aRKfbYTbMeitv3bLEPkq',
                    imagerySet: style
                });
            });
            ['osm', 'sat'].forEach(function (style) {
                sources['MapQuest: ' + style] = new ol.source.MapQuest({
                    layer: style
                });
            });

            var layers = [];
            Object.keys(sources).forEach(function (name) {
                layers.push(new ol.layer.Tile({
                    visible: false,
                    preload: Infinity,
                    source: sources[name]
                }));
            });
            layers.push(new ol.layer.Vector({
                source: selectionLayer,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 0, 0, 0.2)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 2
                    })
                })
            }));

            function formatMGRS(c) {
                return exports.forward(c, 5).replace(/([0-9]*)([A-Z]*)([0-9]{5})([0-9]{5})/, "$1 $2 $3 $4");
            }

            var map = new ol.Map({
                target: 'map',
                controls: ol.control.defaults().extend(
                        [
                            new ol.control.MousePosition({
                                coordinateFormat: function (coordinate) {
                                    return formatMGRS(coordinate);
                                },
                                className: '',
                                projection: 'EPSG:4326',
                                target: document.getElementById('mgrs')
                            }),
                            new ol.control.MousePosition({
                                coordinateFormat: function (coordinate) {
                                    return ol.coordinate.toStringXY(coordinate, 4);
                                },
                                className: '',
                                projection: 'EPSG:4326',
                                target: document.getElementById('latlon')
                            }),
                            new ol.control.MousePosition({
                                coordinateFormat: function (coordinate) {
                                    return ol.coordinate.toStringXY(coordinate, 0); // 0 decimal places
                                },
                                className: '',
                                projection: puwg92,
                                target: document.getElementById('puwg')
                            }),
                            new ol.control.MousePosition({
                                coordinateFormat: function (coordinate) {
                                    return ol.coordinate.toStringXY(coordinate, 0);
                                },
                                className: '',
                                target: document.getElementById('mercator')
                            }),
                            new ol.control.ScaleLine(),
                            new ol.control.ZoomSlider()
                        ]),
                layers: layers,
                view: new ol.View({
                    center: ol.proj.transform([21.03, 52.22], 'EPSG:4326', 'EPSG:3857'),
                    zoom: 10
                })
            });

            var dragBox = new ol.interaction.DragBox({
                condition: ol.events.condition.shiftKeyOnly,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: [0, 0, 255, 1]
                    })
                })
            });
            map.addInteraction(dragBox);
            var selectedBox = null;
            dragBox.on('boxend', function (e) {
                var extent = dragBox.getGeometry().getExtent();
                var x1 = extent[0];
                var y1 = extent[1];
                var x2 = extent[2];
                var y2 = extent[3];
                selectionLayer.clear();
                selectedBox = new ol.Feature(new ol.geom.Polygon([
                    [
                        [x1, y1],
                        [x1, y2],
                        [x2, y2],
                        [x2, y1]
                    ]
                ]));
                document.getElementById('selectionInfo').innerHTML = 'Zaznacznie: '
                        + ((x2 - x1) / 1000).toFixed(1) + ' x ' + ((y2 - y1) / 1000).toFixed(1) + ' km';
                document.getElementById('fetcher').style.display = 'block';
                selectionLayer.addFeature(selectedBox);
            });

            function fetch() {
                var bbox = selectedBox.getGeometry().getExtent();
                var puwg = ol.proj.transform(bbox, 'EPSG:3857', 'EPSG:2180');
                var mgrsTopLeft = exports.forward(ol.proj.transform([bbox[0], bbox[1]], 'EPSG:3857', 'EPSG:4326'), 1);
                window.open('fetch.html', JSON.stringify({
                    z: document.getElementById('getZ').value,
                    source: document.getElementById('getSource').value,
                    title: mgrsTopLeft,
                    box: {
                        x1: puwg[0],
                        y1: puwg[1],
                        x2: puwg[2],
                        y2: puwg[3]
                    }
                }));
            }

            map.on('click', function (evt) {
                var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
                    return feature;
                });
                if (!feature) {
                    return;
                }
                fetch();
            });

            var layerSelection = document.getElementById('layerSelection');
            Object.keys(sources).forEach(function (name) {
                var option = document.createElement('option');
                option.text = name;
                layerSelection.add(option);
            });
            function selectLayer(combo) {
                var idx = combo.selectedIndex;
                var selectableSources = Object.keys(sources).length;
                for (var i = 0; i < selectableSources; i++) {
                    layers[i].setVisible(i === idx);
                }
            }
            selectLayer({selectedIndex: 0});
        </script>
        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
                a = s.createElement(o), m = s.getElementsByTagName(o)[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-54107063-3', 'auto');
            ga('send', 'pageview');

        </script>
    </body>
</html>
