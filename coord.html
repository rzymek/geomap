<!doctype html>
<html lang="en">
    <head>
        <style>
        </style>
        <title>geomap</title>
    </head>
    <body>
        <pre><script type="text/javascript">
            function getBoundsAndMaxResForWMTS(scaleDenominator, topLeftCorner, tileWidth, matrixWidth, tileHeight, matrixHeight) {

                var standardizedRenderingPixelSize = 0.00028;

                var widthPixel = tileWidth * matrixWidth;
                var heightPixel = tileHeight * matrixHeight;

                var right = (scaleDenominator * widthPixel * standardizedRenderingPixelSize) + topLeftCorner.x;
                var bottom = topLeftCorner.y - (scaleDenominator * heightPixel * standardizedRenderingPixelSize);

                var bounds = [topLeftCorner.x, bottom, right, topLeftCorner.y];
                var maxResolutionW = Math.round((right - topLeftCorner.x) / widthPixel);
                var maxResolutionH = Math.round((topLeftCorner.y - bottom) / heightPixel);

                if (maxResolutionW !== maxResolutionH) {
                    throw new Error('Could not calculate ');
                }

                return {
                    bounds: bounds,
                    maxResolution: maxResolutionW
                };
            }

            function puwg() {
                var scaleDenominator = 9449.404761904761;
                var topLeftCorner = {
                    y: 850000.0, //X
                    x: 100000.0//Y
                };
                var tileWidth = 512;
                var matrixWidth = 598;
                var tileHeight = 512;
                var matrixHeight = 562;
                return getBoundsAndMaxResForWMTS(scaleDenominator, topLeftCorner, tileWidth, matrixWidth, tileHeight, matrixHeight);
            }

            function wgs() {
                var scaleDenominator = 9449.404761904761;
                var topLeftCorner = {
                    y: 56.0,
                    x: 12.0
                };
                var tileWidth = 512;
                var matrixWidth = 1104;
                var tileHeight = 512;
                var matrixHeight = 613;
                return getBoundsAndMaxResForWMTS(scaleDenominator, topLeftCorner, tileWidth, matrixWidth, tileHeight, matrixHeight);
            }
            document.writeln(JSON.stringify(puwg()));
            document.writeln(JSON.stringify(wgs()));

            var coord = {x: 483217, y: 640194};

            var b = puwg().bounds;
            bounds = {
                left: b[0],
                bottom: b[1],
                right: b[2],
                top: b[3]
            };

            var limits = {
                MinTileRow: 14,
                MaxTileRow: 561,
                MinTileCol: 18,
                MaxTileCol: 597

//                MinTileCol: 14,
//                MaxTileCol: 561,
//                MinTileRow: 18,
//                MaxTileRow: 597
            };
            tile = {
//                x: limits.MinTileRow +((coord.x - bounds.left) / (bounds.right - bounds.left)) * (limits.MaxTileRow - limits.MinTileRow),
//                y: limits.MinTileCol + ((coord.y - bounds.bottom) / (bounds.top - bounds.bottom)) * (limits.MaxTileCol - limits.MinTileCol),

                x: ((coord.x - bounds.left) / (bounds.right - bounds.left)) * (limits.MaxTileCol - limits.MinTileCol),
                y: ((coord.y - bounds.bottom) / (bounds.top - bounds.bottom)) * (limits.MaxTileRow - limits.MinTileRow),
//                x: ((coord.x - bounds.left) / (bounds.right - bounds.left)) * (limits.MaxTileRow) - limits.MinTileRow,
//                y: ((coord.y - bounds.bottom) / (bounds.top - bounds.bottom)) * (limits.MaxTileCol) - limits.MinTileCol,
//                
//                x: limits.MinTileCol + ((coord.x - bounds.left) / (bounds.right - bounds.left)) * (limits.MaxTileCol),
//                y: limits.MinTileRow + ((coord.y - bounds.bottom) / (bounds.top - bounds.bottom)) * (limits.MaxTileRow),

                z: 9
            };
            var url = 'http://mapy.geoportal.gov.pl/wss/service/WMTS/guest/wmts/TOPO?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=MAPA%20TOPOGRAFICZNA&STYLE=default&FORMAT=image/jpeg&TILEMATRIXSET=EPSG:2180&'
                    + 'TILEMATRIX=EPSG:2180:{{z}}&'
                    + 'TILEROW={{x}}&'
                    + 'TILECOL={{y}}';
            document.writeln(JSON.stringify(bounds));
            document.writeln(JSON.stringify(tile));
            document.writeln((coord.x - bounds.left) / (bounds.right - bounds.left));
            document.writeln((coord.y - bounds.bottom) / (bounds.top - bounds.bottom));
            var n = 3;
            for (var x = 0; x < n; x++) {
                for (var y = 0; y < n; y++) {
//                    var url1 = url.replace('{{z}}', Math.floor(tile.z)).replace('{{y}}', Math.floor(tile.x) + x).replace('{{x}}', Math.floor(tile.y) + y);
                    var url1 = url.replace('{{z}}', Math.floor(tile.z)).replace('{{x}}', Math.floor(tile.x) + x).replace('{{y}}', Math.floor(tile.y) + y);
//                    document.write('<a href="' + url1 + '"><img src="' + url1 + '"></a>');
                }
                document.writeln('');
            }
// http://www.opengeospatial.org/standards/wmts
//  http://portal.opengeospatial.org/files/?artifact_id=35326

            function floor(x) {
                return Math.floor(x);
            }

            var bBoxMinX = coord.y;
            var bBoxMaxX = coord.y;
            var bBoxMaxY = coord.x;
            var bBoxMinY = coord.x;

            var scaleDenominator = 9449.404761904761;
            var topLeftCorner = {
                y: 850000.0, //X
                x: 100000.0//Y
            };
            var tileWidth = 512;
            var matrixWidth = 598;
            var tileHeight = 512;
            var matrixHeight = 562;

            var metersPerUnit = 1;
            var pixelSpan = scaleDenominator * 0.28e-3 / metersPerUnit;

            var tileSpanX = tileWidth * pixelSpan;
            var tileSpanY = tileHeight * pixelSpan;

            var tileMatrixMinX = 100000;
            var tileMatrixMaxY = 850000;
            var tileMatrixMaxX = tileMatrixMinX + tileSpanX * matrixWidth;
            var tileMatrixMinY = tileMatrixMaxY - tileSpanY * matrixHeight;

            var epsilon = 1e-6;
            var tileMinCol = floor((bBoxMinX - tileMatrixMinX) / tileSpanX + epsilon);
            var tileMaxCol = floor((bBoxMaxX - tileMatrixMinX) / tileSpanX - epsilon);
            var tileMinRow = floor((tileMatrixMaxY - bBoxMaxY) / tileSpanY + epsilon);
            var tileMaxRow = floor((tileMatrixMaxY - bBoxMinY) / tileSpanY - epsilon);
            // to avoid requesting out-of-range tiles
            if (tileMinCol < 0)
                tileMinCol = 0;
            if (tileMaxCol >= matrixWidth)
                tileMaxCol = matrixWidth - 1;
            if (tileMinRow < 0)
                tileMinRow = 0;
            if (tileMaxRow >= matrixHeight)
                tileMaxRow = matrixHeight - 1;

            document.writeln(JSON.stringify([
                tileMinRow, tileMinCol,
                tileMaxRow, tileMaxCol
            ]));
            var url1 = url
                    .replace('{{z}}', Math.floor(tile.z))
                    .replace('{{x}}', Math.floor(tileMinRow))
                    .replace('{{y}}', Math.floor(tileMinCol));
            document.write('<a href="' + url1 + '"><img src="' + url1 + '"></a>');

//http://mapy.geoportal.gov.pl/wss/service/WMTS/guest/wmts/TOPO?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=MAPA%20TOPOGRAFICZNA&STYLE=default&FORMAT=image/jpeg&TILEMATRIXSET=EPSG:2180&TILEMATRIX=EPSG:2180:9&
// TILEROW=270&TILECOL=398
                    </script>
Expected: 270 398
        </pre>
    </body>
</html>
